# Lore Agent & Agent-First View â€” Design Doc

**Date:** 2026-02-22
**Status:** Approved

---

## Overview

Introduce **Lore**, a global knowledge agent that manages notes, runs web searches, and answers questions using the full note corpus as context. Complement the existing **Quill** (in-note editor agent, previously "AI sidebar"). Both agents become first-class users of Grove â€” agents can create, read, and edit notes with the same primitives humans use.

---

## Agents

| Agent | Scope | Personality |
|-------|-------|-------------|
| **Lore** | Global â€” across all notes, web, sessions | Chief-of-staff, knows everything |
| **Quill** | Local â€” one note at a time | Focused writing companion |

Both agents use Anthropic's full agentic loop (`tool_use` + multi-turn) via the Agents SDK, replacing the current single-shot `generateText` abstraction.

---

## Routes

```
/                       â†’ redirect (mobile â†’ /chat, desktop â†’ last note or /chat)
/chat                   â†’ Lore full-page (default on mobile)
/chat/[sessionId]       â†’ specific Lore conversation
/note/[noteId]          â†’ editor with Quill sidebar (existing)
/note/[noteId]?lore=1   â†’ editor + Lore floating drawer
```

- Top nav toggle in sidebar switches between `/chat` and `/note/[noteId]` (URL-driven).
- Last-visited route persisted in localStorage for desktop.
- Mobile: `/chat` is default landing.
- `?lore=1` param summons Lore as a floating drawer from the editor. Quill and Lore can coexist on wide screens.

---

## Convex Schema (Re-architecture)

### Notes â€” metadata only, no content blob
```typescript
notes: defineTable({
  title: v.string(),
  managedBy: v.union(v.literal("ai"), v.literal("user")), // default: "ai"
  createdAt: v.number(),
  updatedAt: v.number(),
  lastTaggedAt: v.optional(v.number()),
})
```

### Blocks â€” one row per BlockNote block (source of truth)
```typescript
blocks: defineTable({
  noteId: v.id("notes"),
  blockId: v.string(),          // BlockNote's own stable ID
  type: v.string(),             // paragraph, heading, bulletListItem, etc.
  content: v.any(),             // BlockNote content array for this block
  props: v.optional(v.any()),
  parentId: v.optional(v.string()), // for nested blocks
  order: v.number(),            // float for easy reordering
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_noteId", ["noteId"])
  .index("by_noteId_order", ["noteId", "order"])
  .index("by_blockId", ["blockId"])
```

The BlockNote editor syncs its `onChange` output to this table (debounced). On load, blocks are fetched ordered by `order` and reconstructed into the BlockNote array format.

### Suggested Edits â€” pending AI changes requiring approval
```typescript
suggestedEdits: defineTable({
  noteId: v.id("notes"),
  sessionId: v.optional(v.id("loreConversations")),
  editType: v.union(
    v.literal("create_note"),
    v.literal("add_block"),
    v.literal("update_block"),
    v.literal("delete_block"),
    v.literal("update_title")
  ),
  blockId: v.optional(v.string()),
  before: v.optional(v.any()),
  after: v.optional(v.any()),
  status: v.union(v.literal("pending"), v.literal("accepted"), v.literal("rejected")),
  createdAt: v.number(),
})
  .index("by_noteId", ["noteId"])
  .index("by_status", ["status"])
```

### Lore Conversations
```typescript
loreConversations: defineTable({
  title: v.string(),            // auto-generated by Lore after first exchange
  summary: v.optional(v.string()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_updatedAt", ["updatedAt"])
```

### Lore Chat Messages
```typescript
loreChatMessages: defineTable({
  sessionId: v.id("loreConversations"),
  role: v.union(v.literal("user"), v.literal("assistant")),
  content: v.string(),
  thinkingContent: v.optional(v.string()),  // extended thinking block
  toolCalls: v.optional(v.array(v.object({
    toolName: v.string(),
    input: v.any(),
    output: v.any(),
    durationMs: v.optional(v.number()),
  }))),
  createdAt: v.number(),
})
  .index("by_sessionId", ["sessionId"])
  .index("by_sessionId_createdAt", ["sessionId", "createdAt"])
```

---

## Lore's Tools

| Tool | Description | Needs approval on human-managed note? |
|------|-------------|---------------------------------------|
| `list_notes` | List all notes with titles | No |
| `read_note` | Read full content of a note | No |
| `search_notes` | Full-text search across blocks | No |
| `create_note` | Create a new note | No (new notes are AI-managed by default) |
| `update_block` | Edit a specific block | Yes, if `managedBy: "user"` |
| `add_block` | Add a block to a note | Yes, if `managedBy: "user"` |
| `delete_block` | Delete a block | Yes, if `managedBy: "user"` |
| `update_title` | Rename a note | Yes, if `managedBy: "user"` |
| `web_search` | Search the web via Tavily | No |

**AI-managed notes (`managedBy: "ai"`):** Lore executes mutations directly.
**Human-managed notes (`managedBy: "user"`):** Lore writes a `suggestedEdit` record and presents a diff card in chat. The user accepts or rejects inline.

---

## Note Ownership

- **Default for new notes: `managedBy: "ai"`**
- User can toggle per note from the sidebar (lock icon)
- When Lore creates a note, it's always AI-managed
- Toggling to `"user"` means Lore must propose before touching it

---

## Lore UI

### Desktop `/chat`
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Sidebar    â”‚      Lore chat              â”‚  Note preview    â”‚
â”‚  (notes +    â”‚  (session list at top,      â”‚  (slides in when â”‚
â”‚  nav toggle) â”‚   messages, input)          â”‚  Lore edits a    â”‚
â”‚              â”‚                             â”‚  note, dismiss.) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Note preview panel slides in when Lore references or edits a note
- For human-managed notes, preview shows before/after diff with Accept / Reject
- Session list: dropdown or left column, auto-titled after first exchange

### Mobile `/chat`
- Chat only, full screen
- Inline pill when Lore edits: `"âœ edited Â· Meeting notes Â· 2 blocks"` â€” tappable to open note

### Lore from `/note/[noteId]?lore=1`
- Wide right drawer (400px), overlaps editor
- Pushed via URL param, dismissed via Escape / âœ• / browser back
- Quill (`?ai=1`) and Lore (`?lore=1`) can coexist on wide screens

---

## Observability â€” Tool Call & Thinking Inspector

Every Lore/Quill message with tool use renders an expandable trace:

**Collapsed:**
```
â–¶ 3 steps Â· 1.2s
```

**Expanded:**
```
â–¼ 3 steps Â· 1.2s
  â— thinking  Â·Â·Â·  â–¶           â† tap to expand raw reasoning
  âš™ search_notes  { "query": "sleep research" }
    â†’ 3 blocks matched          â† tap to expand full output
  âš™ update_block  { "blockId": "abc", ... }
    â†’ accepted                  â† or diff card if human-managed
```

- `thinkingContent` and `toolCalls` stored in DB â€” inspectable when revisiting old sessions
- Same component on desktop and mobile (stacks vertically on mobile)
- Suggested edit tool calls render as a diff card with Accept/Reject instead of a plain output line

---

## Web Search UI

When Lore calls `web_search`, results render as a distinct card block in the chat (not inline text):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” "benefits of polyphasic sleep"       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [favicon] SleepFoundation.org           â”‚
â”‚ Polyphasic sleep involves sleeping in   â”‚
â”‚ multiple short segments...              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [favicon] PubMed                        â”‚
â”‚ A 2019 study found that...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Collapsible after first view. Each result links out. Lore's response text appears after the card.

---

## Quill Upgrade

Quill gets the same Agents SDK upgrade as Lore:
- Full agentic loop replaces single-shot `generateText`
- Tool call + thinking inspector renders in the Quill sidebar
- Quill's tools: `read_note`, `update_block`, `add_block` (within current note only)
- Quill also respects `managedBy` â€” proposes edits via `suggestedEdits` if note is human-managed

---

## What's Not In This Design

- Embeddings / vector RAG (V1 uses full-context injection; embeddings added when note count grows)
- Multi-agent coordination (Lore delegating to Quill)
- Agent-to-agent messaging
- Note sharing / collaboration
